<!DOCTYPE html>
<html lang="es" class="brand-tenedorlibre">
  <head>
    <meta charset="utf-8" />
    <title>Ingresar / Registrarme ‚Äî Tenedor Libre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <meta
      name="description"
      content="Inici√° sesi√≥n o cre√° tu cuenta para ver todas las recetas de Tenedor Libre."
    />
    <link rel="stylesheet" href="stylestenedorlibre.css" />
    <!-- Si ten√©s Auth/Intent en tu JS global, lo usamos. No es obligatorio. -->
    <script src="tenedorlibre.js" defer></script>
  </head>
  <body>
    <main class="auth-wrap">
      <section class="auth-card" role="dialog" aria-labelledby="title">
        <header class="auth-head">
          <div class="brand"><span class="brand-text">Tenedor Libre</span></div>
          <h1 id="title" style="margin: 6px 0 0">Inici√° sesi√≥n o registrate</h1>
          <p class="auth-sub">
            Para ver recetas completas y ‚ÄúTodas las recetas‚Äù,
            <b>inici√° sesi√≥n o cre√° tu cuenta</b>. üç≥
          </p>
        </header>

        <div class="auth-tabs" role="tablist" aria-label="Eleg√≠ una opci√≥n">
          <div class="auth-tab">
            <input
              type="radio"
              name="mode"
              id="tab-signin"
              value="signin"
              checked
            />
            <label for="tab-signin" role="tab" aria-controls="panel-auth"
              >Iniciar sesi√≥n</label
            >
          </div>
          <div class="auth-tab">
            <input type="radio" name="mode" id="tab-signup" value="signup" />
            <label for="tab-signup" role="tab" aria-controls="panel-auth"
              >Registrarme</label
            >
          </div>
        </div>

        <form
          id="auth-form"
          class="auth-body"
          autocomplete="on"
          novalidate
          aria-live="polite"
          data-mode="signin"
        >
          <div
            class="form-grid"
            id="panel-auth"
            role="tabpanel"
            aria-labelledby="tab-signin"
          >
            <!-- ======= INICIAR SESI√ìN: USUARIO + CONTRASE√ëA ======= -->
            <fieldset id="signin-fields">
              <div class="form-row">
                <label for="su-username">Nombre de usuario</label>
                <input
                  id="su-username"
                  name="su-username"
                  type="text"
                  inputmode="text"
                  autocomplete="username"
                  placeholder="Tu usuario"
                  required
                />
              </div>
              <div class="form-row">
                <label for="su-password">Contrase√±a</label>
                <input
                  id="su-password"
                  name="su-password"
                  type="password"
                  autocomplete="current-password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                />
              </div>
            </fieldset>

            <!-- ======= REGISTRARME: NOMBRE, APELLIDO, TEL√âFONO, MAIL, USUARIO, CONTRASE√ëA ======= -->
            <fieldset id="signup-fields">
              <div class="grid-2">
                <div class="form-row">
                  <label for="sg-first">Nombre</label>
                  <input
                    id="sg-first"
                    name="sg-first"
                    type="text"
                    inputmode="text"
                    placeholder="Tu nombre"
                  />
                </div>
                <div class="form-row">
                  <label for="sg-last">Apellido</label>
                  <input
                    id="sg-last"
                    name="sg-last"
                    type="text"
                    inputmode="text"
                    placeholder="Tu apellido"
                  />
                </div>
              </div>
              <div class="form-row">
                <label for="sg-phone">Tel√©fono</label>
                <input
                  id="sg-phone"
                  name="sg-phone"
                  type="tel"
                  inputmode="tel"
                  placeholder="+54 9 ..."
                />
              </div>
              <div class="form-row">
                <label for="sg-email">Email</label>
                <input
                  id="sg-email"
                  name="sg-email"
                  type="email"
                  inputmode="email"
                  autocomplete="email"
                  placeholder="Tu@email.com"
                />
              </div>
              <div class="grid-2">
                <div class="form-row">
                  <label for="sg-username">Nombre de usuario</label>
                  <input
                    id="sg-username"
                    name="sg-username"
                    type="text"
                    inputmode="text"
                    placeholder="Tu usuario"
                  />
                </div>
                <div class="form-row">
                  <label for="sg-password">Contrase√±a</label>
                  <input
                    id="sg-password"
                    name="sg-password"
                    type="password"
                    autocomplete="new-password"
                    placeholder="M√≠nimo 6 caracteres"
                  />
                </div>
              </div>
            </fieldset>

            <p class="form-error" aria-live="assertive"></p>
            <button class="btn btn-wide" type="submit">Continuar</button>
            <div class="hl"></div>
            <p class="legal">
              Al continuar acept√°s nuestras <a href="#!">condiciones</a> y
              <a href="#!">pol√≠tica de privacidad</a>.
            </p>
          </div>
        </form>
      </section>
    </main>

    <!-- L√≥gica: tabs, validaci√≥n, guardado en localStorage, redirecci√≥n -->
    <script>
      (function () {
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));
        const form = $("#auth-form");
        const err = $(".form-error");

        // ===== Tabs: cambiar modo y requireds =====
        const setMode = (mode) => {
          form.setAttribute("data-mode", mode);

          const up = mode === "signup";
          // Sign in requireds
          $("#su-username").required = !up;
          $("#su-password").required = !up;
          // Sign up requireds
          [
            "#sg-first",
            "#sg-last",
            "#sg-phone",
            "#sg-email",
            "#sg-username",
            "#sg-password",
          ].forEach((sel) => {
            const el = $(sel);
            if (el) el.required = up;
          });

          err.textContent = "";
        };
        $$("#tab-signin, #tab-signup").forEach((r) => {
          r.addEventListener("change", () => setMode(r.value));
        });
        setMode("signin");

        // ===== Storage helpers =====
        const USERS_KEY = "cmf_users";
        const CURR_KEY = "cmf_current_user";
        const loadUsers = () => {
          try {
            return JSON.parse(localStorage.getItem(USERS_KEY)) || {};
          } catch {
            return {};
          }
        };
        const saveUsers = (obj) => {
          try {
            localStorage.setItem(USERS_KEY, JSON.stringify(obj));
          } catch {}
        };
        const setCurrent = (username) => {
          try {
            localStorage.setItem(CURR_KEY, username);
          } catch {}
        };

        const getRedirectTarget = () => {
          // 1) Intent de tu sitio (si existe), 2) ?redirect de la URL, 3) recetas
          try {
            if (window.Intent && typeof Intent.load === "function") {
              const it = Intent.load();
              if (it && it.href) {
                Intent.clear?.();
                return it.href;
              }
              Intent.clear?.();
            }
          } catch {}
          const p = new URLSearchParams(location.search);
          return p.get("redirect") || "recetas.html";
        };

        // ===== Validadores simples =====
        const isEmail = (s) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s || "");
        const minLen = (s, n) => (s || "").length >= n;

        // ===== Submit =====
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          err.textContent = "";
          const mode = form.getAttribute("data-mode");

          if (mode === "signin") {
            const user = $("#su-username").value.trim();
            const pass = $("#su-password").value;
            const users = loadUsers();
            const u = users[user];
            if (!u) {
              err.textContent = "Usuario no encontrado.";
              return;
            }
            if (u.password !== pass) {
              err.textContent = "Contrase√±a incorrecta.";
              return;
            }

            // Sesi√≥n
            try {
              Auth?.setAuthed?.(u.email, u.first + " " + u.last);
            } catch {}
            try {
              localStorage.setItem(
                "cmf_auth",
                JSON.stringify({
                  email: u.email,
                  name: u.first + " " + u.last,
                  username: u.username,
                  ts: Date.now(),
                })
              );
            } catch {}
            setCurrent(user);
            location.href = getRedirectTarget();
            return;
          }

          // signup
          const first = $("#sg-first").value.trim();
          const last = $("#sg-last").value.trim();
          const phone = $("#sg-phone").value.trim();
          const email = $("#sg-email").value.trim();
          const user = $("#sg-username").value.trim();
          const pass = $("#sg-password").value;

          if (!first || !last || !phone || !email || !user || !pass) {
            err.textContent = "Complet√° todos los campos.";
            return;
          }
          if (!isEmail(email)) {
            err.textContent = "Email inv√°lido.";
            return;
          }
          if (!minLen(pass, 6)) {
            err.textContent = "La contrase√±a debe tener al menos 6 caracteres.";
            return;
          }

          const users = loadUsers();
          if (users[user]) {
            err.textContent = "Ese nombre de usuario ya existe.";
            return;
          }
          if (Object.values(users).some((u) => u.email === email)) {
            err.textContent = "Ese email ya est√° registrado.";
            return;
          }

          users[user] = {
            first,
            last,
            phone,
            email,
            username: user,
            password: pass,
            ts: Date.now(),
          };
          saveUsers(users);

          try {
            Auth?.setAuthed?.(email, first + " " + last);
          } catch {}
          try {
            localStorage.setItem(
              "cmf_auth",
              JSON.stringify({
                email,
                name: first + " " + last,
                username: user,
                ts: Date.now(),
              })
            );
          } catch {}
          setCurrent(user);
          location.href = getRedirectTarget();
        });
      })();
    </script>
  </body>
</html>
